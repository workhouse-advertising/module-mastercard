From 535ed947c780e72b6b08128a1880040127b73edb Mon Sep 17 00:00:00 2001
From: Igor Goltsov <igor@ontapgroup.com>
Date: Thu, 11 Nov 2021 17:47:25 +0300
Subject: [PATCH] MPGS-587: [Target][M2] Merchant | Race condition

---
 .../lib/postponed-adapter-loader-factory.js   | 41 +++++++++++++++++++
 .../view/payment/method-renderer/tns-hpf.js   | 20 +++++++--
 .../web/template/payment/tns-hpf.html         |  4 +-
 3 files changed, 59 insertions(+), 6 deletions(-)
 create mode 100644 view/frontend/web/js/lib/postponed-adapter-loader-factory.js

diff --git a/view/frontend/web/js/lib/postponed-adapter-loader-factory.js b/view/frontend/web/js/lib/postponed-adapter-loader-factory.js
new file mode 100644
index 0000000..cd915f7
--- /dev/null
+++ b/view/frontend/web/js/lib/postponed-adapter-loader-factory.js
@@ -0,0 +1,41 @@
+/*
+ * Copyright (c) 2016-2021 Mastercard
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ * http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+/*global define*/
+define(['jquery'], function ($) {
+    return function (loadAdapterCallback) {
+        var isRenderedPromise = $.Deferred();
+        var isActivatedPromise = $.Deferred();
+
+        $.when(
+            isRenderedPromise,
+            isActivatedPromise
+        ).then(loadAdapterCallback);
+
+        return {
+            setIsRendered: function () {
+                if (isRenderedPromise.state() !== 'resolved') {
+                    isRenderedPromise.resolve();
+                }
+            },
+
+            setIsActivated: function () {
+                if (isActivatedPromise.state() !== 'resolved') {
+                    isActivatedPromise.resolve()
+                }
+            },
+        }
+    }
+});
diff --git a/view/frontend/web/js/view/payment/method-renderer/tns-hpf.js b/view/frontend/web/js/view/payment/method-renderer/tns-hpf.js
index 3ae88ce..fd54c7a 100644
--- a/view/frontend/web/js/view/payment/method-renderer/tns-hpf.js
+++ b/view/frontend/web/js/view/payment/method-renderer/tns-hpf.js
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2016-2020 Mastercard
+ * Copyright (c) 2016-2021 Mastercard
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
@@ -23,7 +23,8 @@ define(
         'Magento_Checkout/js/action/set-payment-information',
         'uiLayout',
         'Magento_Checkout/js/model/full-screen-loader',
-        'Magento_Vault/js/view/payment/vault-enabler'
+        'Magento_Vault/js/view/payment/vault-enabler',
+        'OnTap_MasterCard/js/lib/postponed-adapter-loader-factory',
     ],
     function (
         $,
@@ -33,7 +34,8 @@ define(
         setPaymentInformationAction,
         layout,
         fullScreenLoader,
-        VaultEnabler
+        VaultEnabler,
+        postponedAdapterLoaderFactory
     ) {
         'use strict';
 
@@ -53,12 +55,14 @@ define(
             },
             placeOrderHandler: null,
             validateHandler: null,
+            adapterLoader: null,
             sessionId: null,
 
             initialize: function () {
                 this._super();
                 this.vaultEnabler = VaultEnabler();
                 this.vaultEnabler.setPaymentCode(this.getVaultCode());
+                this.adapterLoader = postponedAdapterLoaderFactory(this.loadAdapter.bind(this))
 
                 return this;
             },
@@ -159,7 +163,7 @@ define(
 
             onActiveChange: function (isActive) {
                 if (isActive && !this.adapterLoaded()) {
-                    this.loadAdapter();
+                    this.setIsActivated();
                 }
             },
 
@@ -330,6 +334,14 @@ define(
 
             threeDSecureCancelled: function () {
                 this.isPlaceOrderActionAllowed(true);
+            },
+
+            setIsRendered: function () {
+                this.adapterLoader.setIsRendered();
+            },
+
+            setIsActivated: function () {
+                this.adapterLoader.setIsActivated();
             }
         });
     }
diff --git a/view/frontend/web/template/payment/tns-hpf.html b/view/frontend/web/template/payment/tns-hpf.html
index 320ca6e..f3a5cc6 100644
--- a/view/frontend/web/template/payment/tns-hpf.html
+++ b/view/frontend/web/template/payment/tns-hpf.html
@@ -1,5 +1,5 @@
 <!--
-  ~ Copyright (c) 2016-2019 Mastercard
+  ~ Copyright (c) 2016-2021 Mastercard
   ~
   ~ Licensed under the Apache License, Version 2.0 (the "License");
   ~ you may not use this file except in compliance with the License.
@@ -14,7 +14,7 @@
   ~ limitations under the License.
   -->
 
-<div class="payment-method" data-bind="css: {'_active': isActive()}">
+<div class="payment-method" data-bind="afterRender: setIsRendered,  css: {'_active': isActive()}">
     <div class="payment-method-title field choice">
         <input type="radio"
                name="payment[method]"
-- 
2.30.2

